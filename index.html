<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>接龍小幫手</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 800px; }
        .description-box {
            background-color: #fff;
            border-radius: 0.5rem;
            padding: 1.5rem;
            white-space: pre-wrap;
            margin-bottom: 1.5rem;
        }
        .table thead th { background-color: #e9ecef; }
        .loading-spinner {
            display: none;
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1050;
        }
        /* 編輯模式下的輸入框樣式 */
        .edit-mode-input {
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
        }
    </style>
</head>
<body>
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <div class="container py-4">
        <header class="text-center mb-4">
            <h1 id="eventTitle">讀取中...</h1>
        </header>

        <main>
            <section id="eventDescriptionSection">
                <h2>活動介紹</h2>
                <div class="description-box shadow-sm" id="eventDescription">
                    <p class="text-muted">正在讀取介紹...</p>
                </div>
            </section>

            <section id="participantSection">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h2>目前名單</h2>
                    <div>
                        <button class="btn btn-outline-secondary btn-sm" id="editBtn"><i class="bi bi-pencil-square"></i> 修改</button>
                        <button class="btn btn-success btn-sm d-none" id="saveBtn"><i class="bi bi-save"></i> 儲存變更</button>
                        <button class="btn btn-danger btn-sm d-none" id="cancelBtn"><i class="bi bi-x-circle"></i> 取消</button>
                    </div>
                </div>
                <div class="table-responsive shadow-sm">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="text-center">
                            <tr>
                                <th scope="col" style="width: 8%;">#</th>
                                <th scope="col" style="width: 28%;">姓名</th>
                                <th scope="col" style="width: 28%;">介紹人</th>
                                <th scope="col" style="width: 36%;">備註</th>
                            </tr>
                        </thead>
                        <tbody id="participantList"></tbody>
                        <tfoot id="addParticipantFooter">
                            <tr>
                                <td class="text-center fw-bold">+</td>
                                <td><input type="text" class="form-control" id="newName" placeholder="您的姓名" required></td>
                                <td><input type="text" class="form-control" id="newIntroducer" placeholder="介紹人 (可選)"></td>
                                <td><input type="text" class="form-control" id="newNote" placeholder="備註 (可選)"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="d-grid gap-2 mt-3" id="submitBtnWrapper">
                    <button class="btn btn-primary btn-lg" id="submitBtn">我要接龍</button>
                </div>
            </section>
        </main>
        
        <footer class="text-center text-muted mt-4">
            <p><small>Powered by LINE Bot & Google Sheets</small></p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'https://tzhengliin.synology.me/bossclass'; // ## 請務必換成您自己的後端網址 ##
        let isEditMode = false;
        let currentParticipants = [];

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sheetTitle = urlParams.get('sheet_title');
            
            const elements = {
                spinner: document.getElementById('loadingSpinner'),
                title: document.getElementById('eventTitle'),
                description: document.getElementById('eventDescription'),
                list: document.getElementById('participantList'),
                newName: document.getElementById('newName'),
                newIntroducer: document.getElementById('newIntroducer'),
                newNote: document.getElementById('newNote'),
                submitBtn: document.getElementById('submitBtn'),
                editBtn: document.getElementById('editBtn'),
                saveBtn: document.getElementById('saveBtn'),
                cancelBtn: document.getElementById('cancelBtn'),
                addFooter: document.getElementById('addParticipantFooter'),
                submitWrapper: document.getElementById('submitBtnWrapper')
            };

            if (!sheetTitle) {
                displayError("頁面網址錯誤", "缺少必要的活動資訊 (sheet_title)。");
                return;
            }

            async function fetchData() {
                toggleLoading(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/api/jielong_data?sheet_title=${encodeURIComponent(sheetTitle)}`);
                    if (!response.ok) throw new Error(`伺服器錯誤: ${response.status}`);
                    const result = await response.json();
                    if (!result.success) throw new Error(result.message);
                    
                    currentParticipants = result.data.participants;
                    renderPage(result.data.description, currentParticipants);
                } catch (error) {
                    displayError("讀取資料失敗", error.message);
                } finally {
                    toggleLoading(false);
                }
            }

            function renderPage(description, participants) {
                elements.title.textContent = description.split('\n')[0].trim();
                elements.description.textContent = description;
                renderTable(participants);
            }

            function renderTable(participants) {
                elements.list.innerHTML = '';
                participants.forEach((p, index) => {
                    let rowHtml;
                    if (isEditMode) {
                        rowHtml = `
                            <tr>
                                <th scope="row" class="text-center">${index + 1}</th>
                                <td><input type="text" class="edit-mode-input" data-row-index="${p.row_index}" data-field="name" value="${escapeHtml(p.name)}"></td>
                                <td><input type="text" class="edit-mode-input" data-row-index="${p.row_index}" data-field="introducer" value="${escapeHtml(p.introducer)}"></td>
                                <td><input type="text" class="edit-mode-input" data-row-index="${p.row_index}" data-field="note" value="${escapeHtml(p.note)}"></td>
                            </tr>`;
                    } else {
                        rowHtml = `
                            <tr class="text-center">
                                <th scope="row">${index + 1}</th>
                                <td>${escapeHtml(p.name)}</td>
                                <td>${escapeHtml(p.introducer)}</td>
                                <td class="text-start">${escapeHtml(p.note)}</td>
                            </tr>`;
                    }
                    elements.list.innerHTML += rowHtml;
                });
            }

            async function submitNewParticipant() {
                const name = elements.newName.value.trim();
                if (!name) {
                    alert('請務必填寫您的姓名！');
                    elements.newName.focus();
                    return;
                }
                
                toggleLoading(true);
                elements.submitBtn.disabled = true;

                try {
                    const response = await fetch(`${API_BASE_URL}/api/add_participant`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            sheet_title: sheetTitle,
                            name: name,
                            introducer: elements.newIntroducer.value.trim(),
                            note: elements.newNote.value.trim()
                        }),
                    });
                    const result = await response.json();
                    if (!result.success) throw new Error(result.message);
                    
                    alert('接龍成功！');
                    elements.newName.value = '';
                    elements.newIntroducer.value = '';
                    elements.newNote.value = '';
                    fetchData();
                } catch (error) {
                    alert(`送出失敗：${error.message}`);
                } finally {
                    toggleLoading(false);
                    elements.submitBtn.disabled = false;
                }
            }
            
            async function saveChanges() {
                const changes = [];
                const inputs = elements.list.querySelectorAll('input.edit-mode-input');
                const changedRows = {};

                inputs.forEach(input => {
                    const rowIndex = input.dataset.rowIndex;
                    const field = input.dataset.field;
                    if (!changedRows[rowIndex]) {
                        const original = currentParticipants.find(p => p.row_index == rowIndex);
                        changedRows[rowIndex] = { row_index: parseInt(rowIndex), ...original };
                    }
                    changedRows[rowIndex][field] = input.value;
                });

                for (const rowIndex in changedRows) {
                    changes.push(changedRows[rowIndex]);
                }
                
                if (changes.length === 0) {
                    alert("沒有任何修改。");
                    toggleEditMode(false);
                    return;
                }

                toggleLoading(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/api/bulk_update_jielong`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ sheet_title: sheetTitle, changes: changes })
                    });
                    const result = await response.json();
                    if (!result.success) throw new Error(result.message);
                    alert("儲存成功！");
                    toggleEditMode(false);
                    fetchData();
                } catch (error) {
                    alert(`儲存失敗: ${error.message}`);
                } finally {
                    toggleLoading(false);
                }
            }

            function toggleEditMode(enable) {
                isEditMode = enable;
                elements.editBtn.classList.toggle('d-none', enable);
                elements.saveBtn.classList.toggle('d-none', !enable);
                elements.cancelBtn.classList.toggle('d-none', !enable);
                elements.addFooter.classList.toggle('d-none', enable);
                elements.submitWrapper.classList.toggle('d-none', enable);
                renderTable(currentParticipants);
            }

            function displayError(title, message) {
                elements.title.textContent = title;
                elements.description.innerHTML = `<div class="alert alert-danger">${message}</div>`;
                document.getElementById('participantSection').style.display = 'none';
            }

            function toggleLoading(isLoading) {
                elements.spinner.style.display = isLoading ? 'block' : 'none';
            }

            function escapeHtml(unsafe) {
                return unsafe ? unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") : "";
            }

            elements.submitBtn.addEventListener('click', submitNewParticipant);
            elements.editBtn.addEventListener('click', () => {
                const password = prompt("請輸入修改密碼：");
                if (password === "1993") {
                    toggleEditMode(true);
                } else if (password !== null) {
                    alert("密碼錯誤！");
                }
            });
            elements.cancelBtn.addEventListener('click', () => toggleEditMode(false));
            elements.saveBtn.addEventListener('click', saveChanges);
            
            fetchData();
        });
    </script>
</body>
</html>
