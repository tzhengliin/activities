<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>接龍小幫手</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 720px;
        }
        .description-box {
            background-color: #fff;
            border-radius: 0.5rem;
            padding: 1.5rem;
            white-space: pre-wrap; /* 保留換行符號 */
            font-family: 'Noto Sans TC', sans-serif;
            margin-bottom: 1.5rem;
        }
        .table thead th {
            background-color: #e9ecef;
        }
        .loading-spinner {
            display: none; /* 預設隱藏 */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1050;
        }
    </style>
</head>
<body>
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="container py-4">
        <header class="text-center mb-4">
            <h1 id="eventTitle">讀取中...</h1>
        </header>

        <main>
            <section id="eventDescriptionSection">
                <h2>活動介紹</h2>
                <div class="description-box shadow-sm" id="eventDescription">
                    <p class="text-muted">正在從 Google Sheet 讀取介紹...</p>
                </div>
            </section>

            <section id="participantSection">
                <h2>目前名單</h2>
                <div class="table-responsive shadow-sm">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="text-center">
                            <tr>
                                <th scope="col" style="width: 10%;">#</th>
                                <th scope="col" style="width: 45%;">姓名</th>
                                <th scope="col" style="width: 45%;">介紹人</th>
                            </tr>
                        </thead>
                        <tbody id="participantList">
                            </tbody>
                        <tfoot>
                            <tr id="inputRow">
                                <td class="text-center fw-bold">+</td>
                                <td><input type="text" class="form-control" id="newName" placeholder="您的姓名" required></td>
                                <td><input type="text" class="form-control" id="newIntroducer" placeholder="介紹人 (可選)"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-primary btn-lg" id="submitBtn">我要接龍</button>
                </div>
            </section>
        </main>
        
        <footer class="text-center text-muted mt-4">
            <p><small>Powered by LINE Bot & Google Sheets</small></p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ####################################################################
        // ##  請將此處的 API_BASE_URL 換成您 ngrok 或正式部署的後端網址  ##
        // ####################################################################
        const API_BASE_URL = 'https://tzhengliin.synology.me/bossclass'; // 例如: https://1a2b-3c4d.ngrok.io
        
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sheetTitle = urlParams.get('sheet_title');
            
            const loadingSpinner = document.getElementById('loadingSpinner');
            const eventTitle = document.getElementById('eventTitle');
            const eventDescription = document.getElementById('eventDescription');
            const participantList = document.getElementById('participantList');
            const newNameInput = document.getElementById('newName');
            const newIntroducerInput = document.getElementById('newIntroducer');
            const submitBtn = document.getElementById('submitBtn');

            if (!sheetTitle) {
                displayError("頁面網址錯誤", "缺少必要的活動資訊 (sheet_title)。");
                return;
            }

            // 讀取活動資料
            async function fetchData() {
                toggleLoading(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/api/jielong_data?sheet_title=${encodeURIComponent(sheetTitle)}`);
                    if (!response.ok) {
                        throw new Error(`伺服器錯誤: ${response.statusText}`);
                    }
                    const data = await response.json();

                    if (!data.success) {
                        displayError("讀取失敗", data.message);
                        return;
                    }
                    
                    renderData(data.data);

                } catch (error) {
                    displayError("網路連線錯誤", `無法從後端讀取資料，請確認後端服務是否正常運作。\n${error.message}`);
                } finally {
                    toggleLoading(false);
                }
            }

            // 渲染頁面內容
            function renderData(data) {
                const title = data.description.split('\n')[0].trim();
                eventTitle.textContent = title;
                eventDescription.textContent = data.description;
                
                participantList.innerHTML = ''; // 清空舊資料
                data.participants.forEach((p, index) => {
                    const row = `
                        <tr class="text-center">
                            <th scope="row">${index + 1}</th>
                            <td>${escapeHtml(p.name)}</td>
                            <td>${escapeHtml(p.introducer)}</td>
                        </tr>`;
                    participantList.innerHTML += row;
                });
            }

            // 送出新名單
            async function submitNewParticipant() {
                const name = newNameInput.value.trim();
                const introducer = newIntroducerInput.value.trim();

                if (!name) {
                    alert('請務必填寫您的姓名！');
                    newNameInput.focus();
                    return;
                }

                toggleLoading(true);
                submitBtn.disabled = true;

                try {
                    const response = await fetch(`${API_BASE_URL}/api/add_participant`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sheet_title: sheetTitle,
                            name: name,
                            introducer: introducer,
                        }),
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        alert('接龍成功！');
                        newNameInput.value = '';
                        newIntroducerInput.value = '';
                        fetchData(); // 重新讀取並刷新列表
                    } else {
                        alert(`接龍失敗：${result.message}`);
                    }

                } catch (error) {
                    alert(`送出失敗，發生網路錯誤：\n${error.message}`);
                } finally {
                    toggleLoading(false);
                    submitBtn.disabled = false;
                }
            }

            // 顯示錯誤訊息
            function displayError(title, message) {
                eventTitle.textContent = title;
                eventDescription.innerHTML = `<div class="alert alert-danger">${message}</div>`;
                document.getElementById('participantSection').style.display = 'none';
            }

            // 其他工具函式
            function toggleLoading(isLoading) {
                loadingSpinner.style.display = isLoading ? 'block' : 'none';
            }
            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // 綁定事件
            submitBtn.addEventListener('click', submitNewParticipant);
            
            // 初始載入
            fetchData();
        });
    </script>
</body>
</html>
